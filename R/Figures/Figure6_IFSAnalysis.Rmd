---
title: "Figure6_TFS_Analysis"
author: "Fabienne RÃ¶ssler"
date: '2023-04-18'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning = FALSE}
source("../DLCAnalyzer_Functions_v4.R")
source("../UnsupervisedAnalysis_Functions.R")
library(rlang)
library(sp)         #tested with v1.3-2
library(imputeTS)   #tested with v2.7
library(ggplot2)    #tested with v3.1.0
library(ggmap)      #tested with v3.0.0
library(data.table) #tested with v1.12.8
library(cowplot)    #tested with v0.9.4
library(corrplot)   #tested with v0.84
library(keras)      #REQUIRES TENSORFLOW INSTALL. tested with v2.2.5.0
library(readr)
library(tidyr)
library(biganalytics)
library(M3C)
library(stringr)
library(reticulate)
library(pROC)
library(yardstick)
set.seed(123)
```

# Figure 6

```{r}
US <- readRDS("../../data/US_IFS_25Clusters_withResilience.rds")
```

```{r}
US1 <- SplitUSData(US, select = US$meta$Session %in% c("OFT1"))
US1 <- TwoGroupAnalysis(US1,group = US1$meta$group, lab = "kmeans.25")

US2 <- SplitUSData(US, select = US$meta$Session %in% c("OFT2"))
US2 <- TwoGroupAnalysis(US2,group = US2$meta$group, lab = "kmeans.25")

US3 <- SplitUSData(US, select = US$meta$Session %in% c("OFT3"))
US3 <- TwoGroupAnalysis(US3,group = US3$meta$group, lab = "kmeans.25")
```


## Barplots showing cluster occurence for OFT2

### OFT2

```{r, fig.height=1.9, fig.width=5.5}
pdat <- US2$Report$kmeans.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US2$meta$filename)
pdat$Group <- US2$meta$group[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(20)

pdat_temp <- pdat[pdat$Group == "Control", ]
df$SEM[df$Group=="Control"] <- aggregate(pdat_temp$value,by = list(pdat_temp$Cluster, pdat_temp$type, pdat_temp$Group), FUN = sd)$x / sqrt(15)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#6CB6E0")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(1:25)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../../Plots/Figure6_barplot_IFS_OFT2.pdf", height = 1.9, width = 5.5)
print(p1)
dev.off()

US2$Results[[1]]$Statistics$kmeans.25

cluster_stats <- US2$Results[[1]]$Statistics$kmeans.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```


## Behavior flow differences for OFT2

### OFT2

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US2, grouping = US2$meta$group == "TFS", lab = "kmeans.25")

pdf("../../Plots/Figure6_IFS_behaviorFlow_OFT2.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US2, grouping = US2$meta$group == "TFS", lab = "kmeans.25")
dev.off()

trans_stats <- US2$Results[[1]]$TransitionStats$kmeans.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated
```

### Boxplot for significant transitions between TFS and control in OFT2

```{r, fig.height=1.5, fig.width=3.3}
p1 <- PlotTransitions(US2,lab = "kmeans.25", from = c("11", "1"), to = c("7", "11"), groupby = "group", cols = c("black","#6CB6E0"))
p1 <- p1 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
print(p1)

pdf("../../Plots/Figure6_signTransition_boxplot_IFS_OFT2.pdf", height = 1.5, width = 3.3)
print(p1)
dev.off()
```


## BFA for OFT1, OFT2 and OFT3

### OFT1

```{r, fig.width=3.9, fig.height=1.3}
PlotTransitionsStats(US1, labels = "kmeans.25")

pdf("../../Plots/Figure6_bootstrapping_IFS_OFT1.pdf", height = 1.3, width = 3.9)
PlotTransitionsStats(US1, labels = "kmeans.25")
dev.off()
```


### OFT2

```{r, fig.width=3.9, fig.height=1.3}
PlotTransitionsStats(US2, labels = "kmeans.25")

pdf("../../Plots/Figure6_bootstrapping_IFS_OFT2.pdf", height = 1.3, width = 3.9)
PlotTransitionsStats(US2, labels = "kmeans.25")
dev.off()
```


### OFT3

```{r, fig.width=3.9, fig.height=1.3}
PlotTransitionsStats(US3, labels = "kmeans.25")

pdf("../../Plots/Figure6_bootstrapping_IFS_OFT3.pdf", height = 1.3, width = 3.9)
PlotTransitionsStats(US3, labels = "kmeans.25")
dev.off()
```


## 2D embedding of all datasets combined

```{r, fig.height=3, fig.width=4.6}
US_org <- readRDS("../../data/US_AllData_25Clusters.rds")
US_all <- SplitUSData(US_org, select = US_org$meta$Session %in% c("CRS1","PostCSI","FST45min","PostYoh","DREADD"))
US_all <- SplitUSData(US_all, omit = names(US_all$files)[US_all$meta$Condition == "Tunnel"] )

US_all <- FuseUSData(US_all, US2)

US_all <- CalculateStabilizedTransitions(US_all,"Condition","Control",subset = US_all$meta$Session == "CRS1")
US_all <- CalculateStabilizedTransitions(US_all,"Condition","Control",subset = US_all$meta$Session == "PostCSI")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","Control",subset = US_all$meta$Session == "FST45min")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","Saline",subset = US_all$meta$Session == "PostYoh")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","saline",subset = US_all$meta$Session == "DREADD")
US_all <- CalculateStabilizedTransitions(US_all,"group","Control",subset = US_all$meta$Session == "OFT2")

US_all$meta$Embedding <- "Control"
US_all$meta$Embedding[US_all$meta$Session == "CRS1" & US_all$meta$Condition != "Control"] <- "CRS"
US_all$meta$Embedding[US_all$meta$Session == "PostCSI" & US_all$meta$Condition != "Control"] <- "CSI"
US_all$meta$Embedding[US_all$meta$Session == "FST45min" & US_all$meta$Treatment != "Control"] <- "FST_45min"
US_all$meta$Embedding[US_all$meta$Session == "PostYoh" & US_all$meta$Treatment != "Saline"] <- "Yohimbin"
US_all$meta$Embedding[US_all$meta$Session == "DREADD" & US_all$meta$Treatment != "saline"] <- "DREADD"
US_all$meta$Embedding[US_all$meta$Session == "OFT2" & US_all$meta$group != "Control"] <- "IFS_OFT2"

p1 <- Plot2DEmbedding(US_all,transitionmatrices_stabilized = "kmeans.25", colorby = "Embedding", colors = c("grey","#009E73","#0072B2","#E69F00", "#D52800","#6CB6E0", "#CC79A7"), seed = 123, plot.sem = TRUE)
p1

pdf("../../Plots/Figure6_2Dembedding_allDatasets.pdf", height = 3, width = 4.6)
print(p1)
dev.off()
```


## 2D-embedding of resilient/susceptible/control animals in OFT2

```{r, fig.height=3.2, fig.width=4.5}
p <- Plot2DEmbedding(US2,transitionmatrices = "kmeans.25",colorby = "resilient_ID", colors =  c("grey", "#5D3A9B", "#E66100"), plot.sem = TRUE, method = "umap", seed = 123)
p

pdf("../../Plots/Figure6_2Dembedding_IFS_resilienceGroups.pdf", height = 3.2, width = 4.5)
print(p)
dev.off()
```

```{r, fig.height=3.2, fig.width=4}
p <- Plot2DEmbedding(US2,transitionmatrices = "kmeans.25",colorby = "perc_resilient", method = "umap", seed = 123)
p

pdf("../../Plots/Figure6_2Dembedding_IFS_resiliencePerc.pdf", height = 3.2, width = 4)
print(p)
dev.off()
```

```{r, fig.height=3.2, fig.width=4}
US2$meta$dist <- US2$Report$raw$bodycentre.distance.moving
US2$meta$dist[US2$meta$group == "Control"] <- NA
p <- Plot2DEmbedding(US2,transitionmatrices = "kmeans.25",colorby = "dist", method = "umap", seed = 123)
p
```


```{r}
US2$Results <- NULL
US2 <- MultipleTwoGroupAnalysis(US2,group = US2$meta$resilient_ID, lab = "kmeans.25")
```


## Barplots showing cluster occurence for resilient vs. susceptible animals

### OFT2

```{r, fig.height=3.1, fig.width=6.9}
US2_TFS <- SplitUSData(US2, select = US2$meta$group %in% c("TFS"))

pdat <- US2_TFS$Report$kmeans.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US2_TFS$meta$filename)
pdat$Group <- US2_TFS$meta$resilient_ID[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(11)

pdat_temp <- pdat[pdat$Group == "resilient", ]
df$SEM[df$Group=="resilient"] <- aggregate(pdat_temp$value,by = list(pdat_temp$Cluster, pdat_temp$type, pdat_temp$Group), FUN = sd)$x / sqrt(9)

df$Group <- factor(df$Group, levels = c("resilient", "susceptible"))

p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("#5D3A9B", "#E66100")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(1:25)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../../Plots/Figure6_barplot_IFS_resilienceGroups_OFT2.pdf", height = 3.1, width = 6.9)
print(p1)
dev.off()

US2_TFS$Results[[2]]$Statistics$kmeans.25

cluster_stats <- US2_TFS$Results[[2]]$Statistics$kmeans.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```


## Behavior flow differences between resilient vs. susceptible animals

### OFT2

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US2_TFS, grouping = US2_TFS$meta$resilient_ID == "susceptible", lab = "kmeans.25")

pdf("../../Plots/Figure6_IFS_behaviorFlow_resilienceGroups_OFT2.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US2_TFS, grouping = US2_TFS$meta$resilient_ID == "susceptible", lab = "kmeans.25")
dev.off()

trans_stats <- US2$Results[[2]]$TransitionStats$kmeans.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated
```


## BFA for OFT2 (resilient vs. susceptible)

### OFT2

```{r, fig.width=3.0, fig.height=3.1}
set.seed(42)
US2_TFS$Results <- NULL
US2_TFS <- TwoGroupAnalysis(US2_TFS,group = US2_TFS$meta$resilient_ID, lab = "kmeans.25")
PlotTransitionsStats(US2_TFS, labels = "kmeans.25")

pdf("../../Plots/Figure6_bootstrapping_IFS_resilienceGroups_OFT2.pdf", height = 3.1, width = 3.0)
PlotTransitionsStats(US2_TFS, labels = "kmeans.25")
dev.off()
```


## Boxplots showing differences in freezing behavior during extinction period

```{r, fig.height=2.6, fig.width=2.2}
US2$meta$resilient_ID <- factor(US2$meta$resilient_ID , levels=c("control", "resilient", "susceptible"))

US2$meta$Ex1 <- as.numeric(gsub(",", ".", US2$meta$Ex1))
p1 <- ggplot(US2$meta, aes(x = resilient_ID,y = Ex1, color = resilient_ID)) + 
  #geom_boxplot(outlier.shape = NA, color = "black", fill = c("grey", "#DDCC77", "#5D3A9B")) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitter(width = 0.15)) + 
  scale_color_manual(values = c("black", "#5D3A9B", "#E66100")) +
  theme_bw() + ylim(min(US2$meta$Ex1), max(US2$meta$Ex1)) +
  labs(y= "freezing %", x = "", title = "Extinction day 1") + theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
p1

one_way_anova <- aov(Ex1 ~ resilient_ID, data = US2$meta)

summary(one_way_anova)

post_hoc_Tukey <- TukeyHSD(one_way_anova)

post_hoc_Tukey

US2$meta$Ex6 <- as.numeric(gsub(",", ".", US2$meta$Ex6))
p2 <- ggplot(US2$meta, aes(x = resilient_ID,y = Ex6, color = resilient_ID)) + 
  #geom_boxplot(outlier.shape = NA, color = "black", fill = c("grey", "#DDCC77", "#5D3A9B")) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitter(width = 0.15)) + 
  scale_color_manual(values = c("black", "#5D3A9B", "#E66100")) +
  theme_bw() + ylim(min(US2$meta$Ex1), max(US2$meta$Ex1)) +
  labs(y= "freezing %", x = "", title = "Extinction day 6") + theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
p2

one_way_anova <- aov(Ex6 ~ resilient_ID, data = US2$meta)

summary(one_way_anova)

post_hoc_Tukey <- TukeyHSD(one_way_anova)

post_hoc_Tukey

pdf("../../Plots/Figure6_boxplots_IFS_extinctionDay1.pdf", height = 2.6, width = 2.2)
print(p1)
dev.off()

pdf("../../Plots/Figure6_boxplots_IFS_extinctionDay6.pdf", height = 2.6, width = 2.2)
print(p2)
dev.off()
```



