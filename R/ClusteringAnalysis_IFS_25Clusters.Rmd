---
title: "ClusteringAnalysis_IFS_25Clusters"
author: "Fabienne RÃ¶ssler"
date: '2022-12-20'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load all libraries:

```{r, message=FALSE, warning = FALSE}
source("DLCAnalyzer_Functions_v4.R")
source("UnsupervisedAnalysis_Functions.R")
source("FuseUSData.R")
library(sp)         #tested with v1.3-2
library(imputeTS)   #tested with v2.7
library(ggplot2)    #tested with v3.1.0
library(ggmap)      #tested with v3.0.0
library(data.table) #tested with v1.12.8
library(cowplot)    #tested with v0.9.4
library(corrplot)   #tested with v0.84
library(keras)      #REQUIRES TENSORFLOW INSTALL. tested with v2.2.5.0
library(readr)
library(tidyr)
library(biganalytics)
library(M3C)
library(circlize)
library(pracma)
library(tidyr)
library(lme4)
library(lmerTest)
set.seed(123)
```

# Clustering analysis of inescapable footshock (IFS) experiment

We add labels to all files using the cluster classifiers.

```{r, eval = FALSE}
model_kmeans25 <- load_model_hdf5("../kmeans_classifiers/kmeans.25.model.hdf5")
model_kmeans25_para <- readRDS("../kmeans_classifiers/kmeans.25.model.PARAMETERS.rds")

pipeline <- function(path){
  Tracking <- ReadDLCDataFromCSV(path, fps = 25)
  Tracking$data$centre <- NULL
  Tracking <- CutTrackingData(Tracking,start = 300,end = 300)
  Tracking <- CalibrateTrackingData(Tracking, "area",in.metric = 42*42, c("tr","tl","bl","br"))
  Tracking <- AddOFTZones(Tracking)
  Tracking <- CleanTrackingData(Tracking, likelihoodcutoff = 0.95, existence.pol = ScalePolygon(Tracking$zones$arena,1.3))
  Tracking <- CalculateAccelerations(Tracking)
  Tracking <- CreateSkeletonData_OFT_v4(Tracking)
  Tracking <- ZscoreNormalizeFeatures(Tracking,omit =names(Tracking$features)[c(1:23)],type = "mean")
  Tracking$features <- ScaleFeatures(Tracking$features, select = names(Tracking$features)[1:11], factor = 4)
  Tracking$features <- ScaleFeatures(Tracking$features, select = names(Tracking$features)[20:23], factor = 0.1)
  
  Tracking <- OFTAnalysis(Tracking, points = "bodycentre" ,movement_cutoff = 5, integration_period = 5)
  
  Tracking <- ClassifyBehaviors(Tracking, model_kmeans25, model_kmeans25_para)
  Tracking$labels$kmeans.25 <- Tracking$labels$classifications
  
  Tracking$labels$classifications <- NULL
  Tracking$train_x <- NULL
  return(Tracking)
}


path <- "../data/IFS/"
files <- grep(pattern = ".csv",list.files(path),value = TRUE)
ts <- RunPipeline(files,path,pipeline)

for(i in names(ts)){
  ts[[i]]$train_x <- NULL
}

saveRDS(ts,"../data/TS_IFS_25Clusters.rds")
```

Next, we create an unsupervised analysis dataobject (called "US"). We add the metadata which contains the experimental details and save it as one US object.

```{r, eval = FALSE}
ts<- readRDS("../data/TS_IFS_25Clusters.rds")

US <- LoadFromTrackingObject(ts)
meta <- read.table("../metadata/IFS_metadata.csv", sep = ";", header = T)
colnames(meta)[1] <- "Filename"
rownames(meta) <- meta$Filename
meta$Filename <- NULL

US <- AddMetaData(US, meta)

saveRDS(US,"../data/US_IFS_25Clusters_unprocessed.rds")
```


## Pre-processing of data

We load the unsupervised analysis object.

```{r}
US <- readRDS("../data/US_IFS_25Clusters_unprocessed.rds")
```

We first smooth the data over 5 frames, this removes clusters that were identified in a single frame and ensures that behavior trains are better resolved.

```{r, eval = FALSE}
US <- SmoothLabels_US(US, 5)
```

We calculate metrics, such as number of onset-offset and number of frames for each cluster.

```{r, eval = FALSE}
US <- CalculateMetrics(US)
```

Next, we calculate the transitionsmatrix for each clustering analysis in each file.

```{r, eval = FALSE}
US <- AddTransitionMatrixData(US)
```

We save this object, so next time we do not have to re-process it.

```{r, eval = FALSE}
saveRDS(US,"../data/US_IFS_25Clusters_processed.rds")
```
