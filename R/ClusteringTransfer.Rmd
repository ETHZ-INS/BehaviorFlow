---
title: "ClusteringTransfer"
author: "Lukas von Ziegler"
date: '2022-09-19'
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

required libraries

```{r, message=FALSE, warning = FALSE}
source("UnsupervisedAnalysis_Functions.R")
library(ggplot2)
library(circlize)
library(cowplot)
library(pracma)
library(circlize)
library(tidyr)
set.seed(123)
```

# Loading and pre-processing the data

We load the data for the unsupervised analysis object that we produced using kmeans clustering

```{r}
US <- readRDS("../data/USData_transfer.rds")
```

we first smooth the data over 5 frames, this removes clusters that were identified in a single frame and ensures that beahvior trains are better resolved

```{r, eval = FALSE}
US <- SmoothLabels_US(US, 5)
```

We calculate metrics, such as number of onset-offset and number of frames for each cluster.

```{r, eval = FALSE}
US <- CalculateMetrics(US)
```

Next, we calculate the trainsitionsmatrix for each clustering analysis in each file

```{r, eval = FALSE}
US <- AddTransitionMatrixData(US)
```

We finally calculate the confusion matrix between each clustering result across all files. this will allow us to compare different algorithms and see if they result in clusters that map strongly to each other

```{r, eval = FALSE}
US <- AddConfusionMatrix(US)
```

We save this object, so next time we do not have to re-process it

```{r, eval = FALSE}
saveRDS(US,"../data/USData_transfer.rds")
```

# Analysis

## Analysis of Clustering characteristics

In this section we will investigate how well clusters from different kmeans algorithms correlate to each other and to rearing beahavoir in mice

### Mapping to rearing beahviors


```{r, fig.height=1.2, fig.width=3}
US <- readRDS("../data/USData_transfer.rds")
PlotConfusionMatrix(US$ConfusionMatrix_norm$`kmeans.10-rear.classifier`,pointsize = 4, hclust = TRUE)
```

```{r, fig.height=1.2, fig.width=4.5}
PlotConfusionMatrix(US$ConfusionMatrix_norm$`kmeans.25-rear.classifier`,pointsize = 4, hclust = TRUE)
```

```{r, fig.height=1.2, fig.width=7}
PlotConfusionMatrix(US$ConfusionMatrix_norm$`kmeans.50-rear.classifier`,pointsize = 4, hclust = TRUE)
```

```{r, fig.height=1.2, fig.width=10}
PlotConfusionMatrix(US$ConfusionMatrix_norm$`kmeans.100-rear.classifier`,pointsize = 4, hclust = TRUE)
```
we notice that with increase clusters numbers more specifically map to annotated beahviors in general

### Sensitivit to resolve Phenotype (DREADD)

```{r, fig.height=6, fig.width=6}
US2 <-SplitUSData(US, select = (US$meta$Session == "DREADD"))
US2$Results <- NULL
PlotBehaviorFlow_Delta(US2, US2$meta$Treatment == "cloz", lab = "kmeans.25")
PlotBehaviorFlow_Delta(US2, US2$meta$Treatment == "cloz", lab = "kmeans.25", method = "up")
PlotBehaviorFlow_Delta(US2, US2$meta$Treatment == "cloz", lab = "kmeans.25", method = "down")
US2 <- TwoGroupAnalysis(US2, US2$meta$Treatment)

#classical readouts
head(US2$Results[[1]]$Statistics$raw)

#clusters stats
head(US2$Results[[1]]$Statistics$kmeans.25)

#clusters Transition Stats
head(US2$Results[[1]]$TransitionStats$kmeans.25$transitions)

US$Results <- US2$Results
```

```{r, fig.width= 6, fig.height=12}
PlotTransitionsStats(US2)
```

### Sensitivit to resolve Phenotype (CRS1)

```{r, fig.height=6, fig.width=6}
US2 <-SplitUSData(US, select = (US$meta$Session == "CRS1"))
US2$Results <- NULL
PlotBehaviorFlow_Delta(US2, US2$meta$Condition == "Repeated", lab = "kmeans.25")
PlotBehaviorFlow_Delta(US2, US2$meta$Condition == "Repeated", lab = "kmeans.25", method = "up")
PlotBehaviorFlow_Delta(US2, US2$meta$Condition == "Repeated", lab = "kmeans.25", method = "down")
US2 <- TwoGroupAnalysis(US2, US2$meta$Condition)

#classical readouts
head(US2$Results[[1]]$Statistics$raw)

#clusters stats
head(US2$Results[[1]]$Statistics$kmeans.25)

#clusters Transition Stats
head(US2$Results[[1]]$TransitionStats$kmeans.25$transitions)

US$Results <- US2$Results
```

```{r, fig.width= 6, fig.height=12}
PlotTransitionsStats(US2)
```

### Figerprinting plots (stabilized transitionmatrix 2D embedding)

Now we stabilize transitionmatrices within sessions (i.e normalize to control group) and then do a 2D embedding to show behavioral phenotyping on a per sample level

```{r, fig.width= 5, fig.height=4}
US2 <- SplitUSData(US, select = US$meta$Session %in% c("CRS1","PostCSI","FST45min","PostYoh","DREADD"))
US2 <- CalculateStabilizedTransitions(US2,"Condition","Control",subset = US2$meta$Session == "CRS1")
US2 <- CalculateStabilizedTransitions(US2,"Condition","Control",subset = US2$meta$Session == "PostCSI")
US2 <- CalculateStabilizedTransitions(US2,"Treatment","Control",subset = US2$meta$Session == "FST45min")
US2 <- CalculateStabilizedTransitions(US2,"Treatment","Saline",subset = US2$meta$Session == "PostYoh")
US2 <- CalculateStabilizedTransitions(US2,"Treatment","saline",subset = US2$meta$Session == "DREADD")

US2$meta$Embedding <- "Control"
US2$meta$Embedding[US2$meta$Session == "CRS1" & US2$meta$Condition != "Control"] <- "CRS"
US2$meta$Embedding[US2$meta$Session == "PostCSI" & US2$meta$Condition != "Control"] <- "CSI"
US2$meta$Embedding[US2$meta$Session == "FST45min" & US2$meta$Treatment != "Control"] <- "FST"
US2$meta$Embedding[US2$meta$Session == "PostYoh" & US2$meta$Treatment != "Saline"] <- "Yohimbin"
US2$meta$Embedding[US2$meta$Session == "DREADD" & US2$meta$Treatment != "saline"] <- "DREADD"

p1 <- Plot2DEmbedding(US2,transitionmatrices_stabilized = "kmeans.25", colorby = "Embedding", colors = c("grey","red1","orange","blue","purple","green4"), seed = 1)
p2 <- Plot2DEmbedding(US2,transitionmatrices_stabilized = "kmeans.25", colorby = "Embedding", colors = c("black","red1","orange","blue","purple","green4"), plot.density = TRUE, seed = 1)

p1 <- Plot2DEmbedding(US2,transitionmatrices_stabilized = "kmeans.25", colorby = "Dosage", seed = 1)


p2$layers[[1]] <- NULL
print(p2)
```



### Figerprinting plots (stabilized transitionmatrix 2D embedding). 50 clusters

The same with 50 clusters

```{r, fig.width= 5, fig.height=4}

p1 <- Plot2DEmbedding(US2,transitionmatrices_stabilized = "kmeans.50", colorby = "Embedding", colors = c("grey","red1","orange","blue","purple","green4"))
p2 <- Plot2DEmbedding(US2,transitionmatrices_stabilized = "kmeans.50", colorby = "Embedding", colors = c("black","red1","orange","blue","purple","green4"), plot.density = TRUE)


p1 <- Plot2DEmbedding(US2,transitionmatrices_stabilized = "kmeans.50", colorby = "Dosage")


p2$layers[[1]] <- NULL
print(p2)
```


