---
title: "SensitivityCurves_CSI"
author: "Fabienne RÃ¶ssler"
date: '2023-02-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning = FALSE}
source("DLCAnalyzer_Functions_v4.R")
source("UnsupervisedAnalysis_Functions.R")
library(sp)         #tested with v1.3-2
library(imputeTS)   #tested with v2.7
library(ggplot2)    #tested with v3.1.0
library(ggmap)      #tested with v3.0.0
library(data.table) #tested with v1.12.8
library(cowplot)    #tested with v0.9.4
library(corrplot)   #tested with v0.84
library(keras)      #REQUIRES TENSORFLOW INSTALL. tested with v2.2.5.0
library(readr)
library(tidyr)
library(biganalytics)
library(M3C)
library(stringr)
library(reticulate)
set.seed(123)
```

# Compute sensitivity curves for different cluster numbers and integration periods (only on CSI data)

## Run k-means for k = 10 and 25 (with integration period = 15)

We first define our pipeline:

```{r, eval = FALSE}
pipeline <- function(path){
  Tracking <- ReadDLCDataFromCSV(path, fps = 25)
  Tracking$data$centre <- NULL
  Tracking <- CutTrackingData(Tracking,start = 300,end = 300)
  Tracking <- CalibrateTrackingData(Tracking, "area",in.metric = 42*42, c("tr","tl","bl","br"))
  Tracking <- AddOFTZones(Tracking)
  Tracking <- CleanTrackingData(Tracking, likelihoodcutoff = 0.95, existence.pol = ScalePolygon(Tracking$zones$arena,1.3))
  Tracking <- CalculateAccelerations(Tracking)
  Tracking <- CreateSkeletonData_OFT_v4(Tracking)
  Tracking <- ZscoreNormalizeFeatures(Tracking,omit =names(Tracking$features)[c(1:23)],type = "mean")
  Tracking$features <- ScaleFeatures(Tracking$features, select = names(Tracking$features)[1:11], factor = 4)
  Tracking$features <- ScaleFeatures(Tracking$features, select = names(Tracking$features)[20:23], factor = 0.1)
  Tracking <- CreateTestSet(Tracking, integration_period = 15)
  return(Tracking)
}
```

We then load all 59 CSI files:

```{r, eval = FALSE}
path <- "../data/CSI/"
files <- grep(pattern = ".csv",list.files(path),value = TRUE)
ts <- RunPipeline(files,path,pipeline)

#Lets ensure we have all 59 files
names(ts)
```

We are now ready to run the k-means clustering with 10 centers.

```{r, eval = FALSE}
ts <- UnsupervisedClusteringKmeans(ts, N_clusters = 10, Z_score_Normalize = TRUE)
```

Save tracking object

```{r, eval = FALSE}
ts2 <- ts

for(j in names(ts2)) {
  ts2[[j]]$labels[["kmeans.10_CSI"]] <- ts2[[j]]$labels$unsupervised
  ts2[[j]]$labels$unsupervised <- NULL
}

for(i in names(ts2)){
  ts2[[i]]$train_x <- NULL
}

saveRDS(ts2,"../data/TS_CSI_10_Clusters.rds")
```

We also run the k-means clustering with 25 centers.

```{r, eval = FALSE}
ts <- UnsupervisedClusteringKmeans(ts, N_clusters = 25, Z_score_Normalize = TRUE)

ts2 <- ts

for(j in names(ts2)) {
  ts2[[j]]$labels[["kmeans.25_CSI"]] <- ts2[[j]]$labels$unsupervised
  ts2[[j]]$labels$unsupervised <- NULL
}

for(i in names(ts2)){
  ts2[[i]]$train_x <- NULL
}

saveRDS(ts2,"../data/TS_CSI_25_Clusters.rds")
```


## Run k-means for different integration periods (5, 10, 30) and different cluster numbers (10, 25, 70, 100)

```{r, eval = FALSE}
ip <- c(5, 10, 30)

# Define pipeline
pipeline <- function(path){
  Tracking <- ReadDLCDataFromCSV(path, fps = 25)
  Tracking$data$centre <- NULL
  Tracking <- CutTrackingData(Tracking,start = 300,end = 300)
  Tracking <- CalibrateTrackingData(Tracking, "area",in.metric = 42*42, c("tr","tl","bl","br"))
  Tracking <- AddOFTZones(Tracking)
  Tracking <- CleanTrackingData(Tracking, likelihoodcutoff = 0.95, existence.pol = ScalePolygon(Tracking$zones$arena,1.3))
  Tracking <- CalculateAccelerations(Tracking)
  Tracking <- CreateSkeletonData_OFT_v4(Tracking)
  Tracking <- ZscoreNormalizeFeatures(Tracking,omit =names(Tracking$features)[c(1:23)],type = "mean")
  Tracking$features <- ScaleFeatures(Tracking$features, select = names(Tracking$features)[1:11], factor = 4)
  Tracking$features <- ScaleFeatures(Tracking$features, select = names(Tracking$features)[20:23], factor = 0.1)
  Tracking <- CreateTestSet(Tracking, integration_period = ip)
  return(Tracking)
}

path <- "../data/CSI/"
files <- grep(pattern = ".csv",list.files(path),value = TRUE)
ts <- RunPipeline(files,path,pipeline)

# Run kmeans with different number of centers
centers <- c(10,25,70,100)

for(i in centers){
  ts <- UnsupervisedClusteringKmeans(ts, N_clusters = i,Z_score_Normalize = TRUE)
  for(j in names(ts)){
    ts[[j]]$labels[[paste("kmeans.",i,".",ip,"_CSI",sep = "")]] <- ts[[j]]$labels$unsupervised
    ts[[j]]$labels$unsupervised <- NULL
  }
}

ts2 <- ts
for(i in names(ts2)){
  ts2[[i]]$train_x <- NULL
}

# Save the data
saveRDS(ts2,paste("../data/TS_integrationPeriod",ip,".rds",sep = ""))
```


## Combine all simulations into one US object

```{r, eval = FALSE}
# Load US object containing labeling of VAME, BSOID and kmeans for k = 70
US <- readRDS("../data/US_ComparisonClustering_CSI_unprocessed.rds")
````

Now, we add the labeling of all the other k-means variations (different amount of clusters and different integration periods):

```{r, eval = FALSE}
# different clusters
ts <- readRDS("../data/TS_CSI_10_Clusters.rds")
US <- AddFromTrackingObject(US, ts)
saveRDS(US,"../data/US_CSI_SensitivityAssays_unprocessed.rds")

ts <- readRDS("../data/TS_CSI_25_Clusters.rds")
US <- AddFromTrackingObject(US, ts)
saveRDS(US,"../data/US_CSI_SensitivityAssays_unprocessed.rds")

ts <- readRDS("../data/TS_100_Clusters.rds")
US <- AddFromTrackingObject(US, ts)
saveRDS(US,"../data/US_CSI_SensitivityAssays_unprocessed.rds")

# different integration periods
ts <- readRDS("../data/TS_integrationPeriod5.rds")
US <- AddFromTrackingObject(US, ts)
saveRDS(US,"../data/US_CSI_SensitivityAssays_unprocessed.rds")

ts <- readRDS("../data/TS_integrationPeriod10.rds")
US <- AddFromTrackingObject(US, ts)
saveRDS(US,"../data/US_CSI_SensitivityAssays_unprocessed.rds")

ts <- readRDS("../data/TS_integrationPeriod30.rds")
US <- AddFromTrackingObject(US, ts)
saveRDS(US,"../data/US_CSI_SensitivityAssays_unprocessed.rds")
````

We also shortly preprocess all labels (again) to make sure all labels got the same "treatment".

```{r, eval = FALSE}
US <- readRDS("../data/US_CSI_SensitivityAssays_unprocessed.rds")

US <- SmoothLabels_US(US, 5)
US <- CalculateMetrics(US)
US <- AddTransitionMatrixData(US)

saveRDS(US,"../data/US_CSI_SensitivityAssays_processed.rds")
```

## Run in situ sensitivity assays

First, we run the sensitivity assay for the best classical behavior readout, the best cluster and the best transition (using k-means clustering with 70 clusters and integration period 15).

```{r, eval = FALSE}
US <- readRDS("../data/US_CSI_SensitivityAssays_processed.rds")
US_temp <- readRDS("../data/US_AllData.rds")
US_temp <- SplitUSData(US_temp,select = US_temp$meta$Session =="PostCSI")
US$Report$raw <- US_temp$Report$raw

set.seed(123)
classical_readouts <- c("classifications.Supported.count","classifications.Unsupported.count","bodycentre.center.total.time","bodycentre.distance.moving")

brk <- 50
nsim <- 4

Res <- NULL
for(i in brk){
  for(j in 1:nsim){
    print(paste(i, j, sep = " "))
    #ensure we have the same number of samples here (otherwise we may get 7x3 or something)
    equal = FALSE
    while(!equal){
      US3 <- SplitUSData(US, include = sample(US$file_names)[1:i])
      if(table(US3$meta$Condition)[1] == i/2){
        US3 <- TwoGroupAnalysis(US3, US3$meta$Condition,lab = c("kmeans.70_CSI"))
        equal = TRUE
      }
    }
    pcares <- TwoGroupAnalysis_PCA_Report(US3,group = US3$meta$Condition)
    Res <- rbind(Res,data.frame(n_animals = i, 
                                n_sim = j, 
                                kmeans.70.topclust.FDR = US3$Results[[1]]$Statistics[["kmeans.70_CSI"]]$FDR[1],
                                kmeans.70.topclust.p = US3$Results[[1]]$Statistics[["kmeans.70_CSI"]]$p[1],
                                kmeans.70.toptrans.FDR = US3$Results[[1]]$TransitionStats[["kmeans.70_CSI"]]$transitions$FDR[1],
                                kmeans.70.toptrans.p = US3$Results[[1]]$TransitionStats[["kmeans.70_CSI"]]$transitions$p.value[1],
                                DLC.top.FDR = US3$Results[[1]]$Statistics$raw[1,3],
                                classical.top.p = min(1,US3$Results[[1]]$Statistics$raw[US3$Results[[1]]$Statistics$raw$name %in% classical_readouts,][1,2] * length(classical_readouts)),
                                DLC.PCA.p = pcares$stats$`Pr(>Chi)`[2]))
  }
}

saveRDS(Res,"../data/CSI_Sensitivity_50sim_classical.rds")
```

We then run another sensitivity assay for all the different clustering algorithms (k-means, VAME and B-SOiD), cluster numbers and integration periods.

```{r, eval = FALSE}
US <- readRDS("../data/US_CSI_SensitivityAssays_processed.rds")

for (i in US$label_names) {
  US$Report[[i]] <- replace(US$Report[[i]], is.na(US$Report[[i]]), 0)
}

set.seed(123)
classical_readouts <- c("classifications.Supported.count","classifications.Unsupported.count","bodycentre.center.total.time","bodycentre.distance.moving")

brk <- c(50,40,30,20,10)
nsim <- 50


Res <- NULL
for(i in brk){
  for(j in 1:nsim){
    print(paste(i, j, sep = " "))
    #ensure we have the same number of samples here (otherwise we may get 7x3 or something)
    equal = FALSE
    while(!equal){
      US2 <- SplitUSData(US, include = sample(US$file_names)[1:i])
      if(table(US2$meta$Condition)[1] == i/2){
        US2 <- TwoGroupAnalysis(US2, US2$meta$Condition,lab = c("BSOID.8", "VAME.80", "kmeans.10_CSI", "kmeans.25_CSI","kmeans.70_CSI","kmeans.100_CSI", "kmeans.10.5_CSI", "kmeans.25.5_CSI",
                                                                "kmeans.70.5_CSI", "kmeans.100.5_CSI", "kmeans.10.10_CSI", "kmeans.25.10_CSI", "kmeans.70.10_CSI", "kmeans.100.10_CSI",
                                                                "kmeans.10.30_CSI", "kmeans.25.30_CSI", "kmeans.70.30_CSI", "kmeans.100.30_CSI"))
        equal = TRUE
      }
    }
    pcares <- TwoGroupAnalysis_PCA_Report(US2,group = US2$meta$Condition)
    Res <- rbind(Res,data.frame(n_animals = i, 
                                n_sim = j, 
                                file_names = US2$file_names,
                                BSOID.8.matstats.p = US2$Results[[1]]$TransitionStats[["BSOID.8"]]$p.value,
                                VAME.80.matstats.p = US2$Results[[1]]$TransitionStats[["VAME.80"]]$p.value,
                                kmeans.10.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.10_CSI"]]$p.value,
                                kmeans.25.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.25_CSI"]]$p.value,
                                kmeans.70.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.70_CSI"]]$p.value,
                                kmeans.100.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.100_CSI"]]$p.value,
                                kmeans.10.5.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.10.5_CSI"]]$p.value,
                                kmeans.25.5.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.25.5_CSI"]]$p.value,
                                kmeans.70.5.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.70.5_CSI"]]$p.value,
                                kmeans.100.5.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.100.5_CSI"]]$p.value,
                                kmeans.10.10.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.10.10_CSI"]]$p.value,
                                kmeans.25.10.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.25.10_CSI"]]$p.value,
                                kmeans.70.10.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.70.10_CSI"]]$p.value,
                                kmeans.100.10.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.100.10_CSI"]]$p.value,
                                kmeans.10.30.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.10.30_CSI"]]$p.value,
                                kmeans.25.30.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.25.30_CSI"]]$p.value,
                                kmeans.70.30.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.70.30_CSI"]]$p.value,
                                kmeans.100.30.matstats.p = US2$Results[[1]]$TransitionStats[["kmeans.100.30_CSI"]]$p.value,
                                DLC.top.FDR = US2$Results[[1]]$Statistics$raw[1,3],
                                classical.top.p = min(1,US2$Results[[1]]$Statistics$raw[US2$Results[[1]]$Statistics$raw$name %in% classical_readouts,][1,2] * length(classical_readouts)),
                                DLC.PCA.p = pcares$stats$`Pr(>Chi)`[2]))
  }
}

saveRDS(Res,"../data/CSI_ComparisonClustering_Sensitivity_50sim.rds")
```