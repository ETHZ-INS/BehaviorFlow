---
title: "Figure6_TFS_Analysis"
author: "Fabienne RÃ¶ssler"
date: '2023-04-18'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning = FALSE}
source("DLCAnalyzer.R")
source("BFA_BFF.R")
library(rlang)
library(sp)         #tested with v1.3-2
library(imputeTS)   #tested with v2.7
library(ggplot2)    #tested with v3.1.0
library(ggmap)      #tested with v3.0.0
library(data.table) #tested with v1.12.8
library(cowplot)    #tested with v0.9.4
library(corrplot)   #tested with v0.84
library(keras)      #REQUIRES TENSORFLOW INSTALL. tested with v2.2.5.0
library(readr)
library(tidyr)
library(biganalytics)
library(M3C)
library(stringr)
library(reticulate)
library(pROC)
library(yardstick)
library(pwr)
library(rstatix)
set.seed(123)
```

# Figure 6

```{r}
US <- readRDS("../data/US_IFS_25Clusters_withResilience.rds")
```

applying the new BFL

```{r}
US1 <- SplitUSData(US, select = US$meta$Session %in% c("OFT1"))
US1 <- TwoGroupAnalysis(US1,group = US1$meta$group, lab = "kmeans.25")

US2 <- SplitUSData(US, select = US$meta$Session %in% c("OFT2"))
US2 <- TwoGroupAnalysis(US2,group = US2$meta$group, lab = "kmeans.25")
US2 <- StratifyGroups(US2,US2$meta$group, "kmeans.25")
US2$meta$BFL_grouping <- US2$meta$grouping_missclassified
cutoff <- min(US2$meta$ratio[US2$meta$group == "Control"])
US2$meta$BFL_grouping[US2$meta$group == "Control"] <- "Control"
US2$meta$BFL_grouping[US2$meta$group == "TFS"] <- ifelse(US2$meta$ratio[US2$meta$group == "TFS"] > cutoff, "nonresponder", US2$meta$BFL_grouping[US2$meta$group == "TFS"])
US2$meta$BFL_grouping[US2$meta$group == "TFS"] <- ifelse(US2$meta$ratio[US2$meta$group == "TFS"] < cutoff, "responder", US2$meta$BFL_grouping[US2$meta$group == "TFS"])
US2$meta$BFL_grouping <- factor(US2$meta$BFL_grouping, levels =  c("Control","nonresponder","responder"))


US3 <- SplitUSData(US, select = US$meta$Session %in% c("OFT3"))
US3 <- TwoGroupAnalysis(US3,group = US3$meta$group, lab = "kmeans.25")
```


## Barplots showing cluster occurence for OFT2

### OFT2

```{r, fig.height=1.9, fig.width=5.5}
pdat <- US2$Report$kmeans.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US2$meta$filename)
pdat$Group <- US2$meta$group[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(20)

pdat_temp <- pdat[pdat$Group == "Control", ]
df$SEM[df$Group=="Control"] <- aggregate(pdat_temp$value,by = list(pdat_temp$Cluster, pdat_temp$type, pdat_temp$Group), FUN = sd)$x / sqrt(15)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#6CB6E0")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(1:25)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/Figure6_barplot_IFS_OFT2.pdf", height = 1.9, width = 5.5)
print(p1)
dev.off()

US2$Results[[1]]$Statistics$kmeans.25

cluster_stats <- US2$Results[[1]]$Statistics$kmeans.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```


## Behavior flow differences for OFT2

### OFT2

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US2, grouping = US2$meta$group == "TFS", lab = "kmeans.25")

pdf("../Plots_NEWANALYSES/Figure6_IFS_behaviorFlow_OFT2.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US2, grouping = US2$meta$group == "TFS", lab = "kmeans.25")
dev.off()

trans_stats <- US2$Results[[1]]$TransitionStats$kmeans.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated
```

### Boxplot for significant transitions between TFS and control in OFT2

```{r, fig.height=1.5, fig.width=3.3}
p1 <- PlotTransitions(US2,lab = "kmeans.25", from = c("11", "1"), to = c("7", "11"), groupby = "group", cols = c("black","#6CB6E0"))
p1 <- p1 + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
print(p1)

pdf("../Plots_NEWANALYSES/Figure6_signTransition_boxplot_IFS_OFT2.pdf", height = 1.5, width = 3.3)
print(p1)
dev.off()
```


## BFA for OFT1, OFT2 and OFT3

### OFT1

```{r, fig.width=3.9, fig.height=1.3}
PlotTransitionsStats(US1, labels = "kmeans.25")

pdf("../Plots_NEWANALYSES/Figure6_bootstrapping_IFS_OFT1.pdf", height = 1.3, width = 3.9)
PlotTransitionsStats(US1, labels = "kmeans.25")
dev.off()
```


### OFT2

```{r, fig.width=3.9, fig.height=1.3}
PlotTransitionsStats(US2, labels = "kmeans.25")

pdf("../Plots_NEWANALYSES/Figure6_bootstrapping_IFS_OFT2.pdf", height = 1.3, width = 3.9)
PlotTransitionsStats(US2, labels = "kmeans.25")
dev.off()
```


### OFT3

```{r, fig.width=3.9, fig.height=1.3}
PlotTransitionsStats(US3, labels = "kmeans.25")

pdf("../Plots_NEWANALYSES/Figure6_bootstrapping_IFS_OFT3.pdf", height = 1.3, width = 3.9)
PlotTransitionsStats(US3, labels = "kmeans.25")
dev.off()
```


## Power analysis

```{r, fig.width= 4.5, fig.height=2}
include <- "kmeans.25"
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US2, US2$meta$group, lab = k)
  A <- USt$meta$ratio[USt$meta$group == "TFS"]
  B <- USt$meta$ratio[USt$meta$group == "Control"]
  CD <- rbind(CD, data.frame(test = "IFS-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US2$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "IFS-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results <- CohensD_weighted(US1)
Results_trans <- data.frame(test = "IFS-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US2$Results[[1]]$TransitionStats$kmeans.25$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:20
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "kmeans.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#994F88")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") + ylim(0.1, 1) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"))
p

pdf("../Plots_NEWANALYSES/PowerPlot_IFS1_OFT2.pdf", height = 2, width = 4.7)
print(p)
dev.off()
```


## 2D embedding of all datasets combined

```{r, fig.height=3, fig.width=4.6}
US_org <- readRDS("../data/US_AllData_25Clusters.rds")
US_all <- SplitUSData(US_org, select = US_org$meta$Session %in% c("CRS1","PostCSI","FST45min","PostYoh","DREADD"))
US_all <- SplitUSData(US_all, omit = names(US_all$files)[US_all$meta$Condition == "Tunnel"] )

US_all <- FuseUSData(US_all, US2)

US_all <- CalculateStabilizedTransitions(US_all,"Condition","Control",subset = US_all$meta$Session == "CRS1")
US_all <- CalculateStabilizedTransitions(US_all,"Condition","Control",subset = US_all$meta$Session == "PostCSI")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","Control",subset = US_all$meta$Session == "FST45min")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","Saline",subset = US_all$meta$Session == "PostYoh")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","saline",subset = US_all$meta$Session == "DREADD")
US_all <- CalculateStabilizedTransitions(US_all,"group","Control",subset = US_all$meta$Session == "OFT2")

US_all$meta$Embedding <- "Control"
US_all$meta$Embedding[US_all$meta$Session == "CRS1" & US_all$meta$Condition != "Control"] <- "CRS"
US_all$meta$Embedding[US_all$meta$Session == "PostCSI" & US_all$meta$Condition != "Control"] <- "CSI"
US_all$meta$Embedding[US_all$meta$Session == "FST45min" & US_all$meta$Treatment != "Control"] <- "FST_45min"
US_all$meta$Embedding[US_all$meta$Session == "PostYoh" & US_all$meta$Treatment != "Saline"] <- "Yohimbin"
US_all$meta$Embedding[US_all$meta$Session == "DREADD" & US_all$meta$Treatment != "saline"] <- "DREADD"
US_all$meta$Embedding[US_all$meta$Session == "OFT2" & US_all$meta$group != "Control"] <- "IFS_OFT2"

p1 <- Plot2DEmbedding(US_all,transitionmatrices_stabilized = "kmeans.25", colorby = "Embedding", colors = c("grey","#009E73","#0072B2","#E69F00", "#D52800","#6CB6E0", "#CC79A7"), seed = 123, plot.sem = TRUE)
p1

pdf("../Plots_NEWANALYSES/Figure6_2Dembedding_allDatasets.pdf", height = 3, width = 4.6)
print(p1)
dev.off()
```


## Ratio-distribution of responders and non-responders (in OFT2)

```{r, fig.height=2.4, fig.width=3.3}
pdat <- US2$meta

p1 <- ggplot(pdat, aes(BFL_grouping, ratio, color = BFL_grouping)) + geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitterdodge()) +
  scale_color_manual(values = c("black","#5D3A9B", "#E66100")) + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
  #ggtitle("Ratio distribution")
p1

pdf("../Plots_NEWANALYSES/Figure5_ratioDistribution_boxplot_IFS_resilienceGroups.pdf", height = 2.4, width = 3.3)
print(p1)
dev.off()
```


## 2D-embedding of resilient/susceptible/control animals in OFT2

```{r, fig.height=3.2, fig.width=4.5}
p <- Plot2DEmbedding(US2,transitionmatrices = "kmeans.25",colorby = "BFL_grouping", colors =  c("grey", "#5D3A9B", "#E66100"), plot.sem = TRUE, method = "umap", seed = 123)
p

pdf("../Plots_NEWANALYSES/Figure5_2Dembedding_IFS_resilienceGroups.pdf", height = 3.2, width = 4.5)
print(p)
dev.off()
```

```{r, fig.height=3.2, fig.width=4}
p <- Plot2DEmbedding(US2,transitionmatrices = "kmeans.25",colorby = "ratio", method = "umap", seed = 123)
p

pdf("../Plots_NEWANALYSES/Figure5_2Dembedding_IFS_logRatio.pdf", height = 3.2, width = 4)
print(p)
dev.off()
```

```{r, fig.height=3.2, fig.width=4}
US2_test <- US2
US2_test$meta$ratio[US2_test$meta$group == "Control"] <- NA
p <- Plot2DEmbedding(US2_test,transitionmatrices = "kmeans.25",colorby = "ratio", method = "umap", seed = 123)
p
```

```{r, fig.height=3.2, fig.width=4}
US2$meta$dist <- US2$Report$raw$bodycentre.distance.moving
US2$meta$dist[US2$meta$group == "Control"] <- NA
p <- Plot2DEmbedding(US2,transitionmatrices = "kmeans.25",colorby = "dist", method = "umap", seed = 123)
p
```


```{r}
US2$Results <- NULL
US2 <- MultipleTwoGroupAnalysis(US2,group = US2$meta$BFL_grouping, lab = "kmeans.25")
```


## Barplots showing cluster occurence for resilient vs. susceptible animals

### OFT2

```{r, fig.height=2.3, fig.width=7.1}
US2_TFS <- SplitUSData(US2, select = US2$meta$group %in% c("TFS"))

pdat <- US2_TFS$Report$kmeans.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US2_TFS$meta$filename)
pdat$Group <- US2_TFS$meta$BFL_grouping[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(15)

pdat_temp <- pdat[pdat$Group == "non-responder", ]
df$SEM[df$Group=="non-responder"] <- aggregate(pdat_temp$value,by = list(pdat_temp$Cluster, pdat_temp$type, pdat_temp$Group), FUN = sd)$x / sqrt(5)

df$Group <- factor(df$Group, levels = c("non-responder", "responder"))

p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("#5D3A9B", "#E66100")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(1:25)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/Figure5_barplot_IFS_resilienceGroups_OFT2.pdf", height= 2.3, width = 7.1)
print(p1)
dev.off()

US2_TFS$Results[[2]]$Statistics$kmeans.25

cluster_stats <- US2_TFS$Results[[2]]$Statistics$kmeans.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```


## Behavior flow differences between resilient vs. susceptible animals

### OFT2

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US2_TFS, grouping = US2_TFS$meta$BFL_grouping == "responder", lab = "kmeans.25")

pdf("../Plots_NEWANALYSES/Figure5_IFS_behaviorFlow_resilienceGroups_OFT2.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US2_TFS, grouping = US2_TFS$meta$resilient_ID == "susceptible", lab = "kmeans.25")
dev.off()

trans_stats <- US2$Results[[2]]$TransitionStats$kmeans.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated
```


## BFA for OFT2 (resilient vs. susceptible)

### OFT2

```{r, fig.width=4.3, fig.height=3.1}
set.seed(42)
US2_TFS$Results <- NULL
US2_TFS <- TwoGroupAnalysis(US2_TFS,group = US2_TFS$meta$BFL_grouping, lab = "kmeans.25")
PlotTransitionsStats(US2_TFS, labels = "kmeans.25")

pdf("../Plots_NEWANALYSES/Figure5_bootstrapping_IFS_resilienceGroups_OFT2.pdf", height = 3.1, width = 4.3)
PlotTransitionsStats(US2_TFS, labels = "kmeans.25")
dev.off()
```


## Boxplots showing differences in freezing behavior during extinction period

```{r, fig.height=2.6, fig.width=2.2}
US2$meta$BFL_grouping <- factor(US2$meta$BFL_grouping , levels=c("Control", "non-responder", "responder"))

US2$meta$Ex1 <- as.numeric(gsub(",", ".", US2$meta$Ex1))
p1 <- ggplot(US2$meta, aes(x = BFL_grouping,y = Ex1, color = BFL_grouping)) + 
  #geom_boxplot(outlier.shape = NA, color = "black", fill = c("grey", "#DDCC77", "#5D3A9B")) + 
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitter(width = 0.15)) + 
  scale_color_manual(values = c("black", "#5D3A9B", "#E66100")) +
  theme_bw() + ylim(min(US2$meta$Ex1), max(US2$meta$Ex1)) +
  labs(y= "freezing %", x = "", title = "Extinction day 1") + theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
p1

one_way_anova <- aov(Ex1 ~ BFL_grouping, data = US2$meta)

summary(one_way_anova)

post_hoc_Tukey <- TukeyHSD(one_way_anova)

post_hoc_Tukey

US2$meta$Ex6 <- as.numeric(gsub(",", ".", US2$meta$Ex6))
p2 <- ggplot(US2$meta, aes(x = BFL_grouping,y = Ex6, color = BFL_grouping)) + 
  #geom_boxplot(outlier.shape = NA, color = "black", fill = c("grey", "#DDCC77", "#5D3A9B")) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitter(width = 0.15)) + 
  scale_color_manual(values = c("black", "#5D3A9B", "#E66100")) +
  theme_bw() + ylim(min(US2$meta$Ex1), max(US2$meta$Ex1)) +
  labs(y= "freezing %", x = "", title = "Extinction day 6") + theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
p2

one_way_anova <- aov(Ex6 ~ BFL_grouping, data = US2$meta)

summary(one_way_anova)

post_hoc_Tukey <- TukeyHSD(one_way_anova)

post_hoc_Tukey

# pdf("../Plots_NEWANALYSES/Figure6_boxplots_IFS_extinctionDay1.pdf", height = 2.6, width = 2.2)
# print(p1)
# dev.off()
# 
# pdf("../Plots_NEWANALYSES/Figure6_boxplots_IFS_extinctionDay6.pdf", height = 2.6, width = 2.2)
# print(p2)
# dev.off()
```

## NEW FIGURE that performs AOV within each session seperately

Here we create a new plot that shows all the extinction sessions in one single graph and statistical values are assessed in each session independently

```{r, fig.width= 6.4, fig.height=3.1}
pdat <- US2$meta

#fix commas etc
cols <- c("PRE","Ex1","Ex2","Ex3","Ex4","Ex5","Ex6")
for(i in cols){
  pdat[,paste(i)] <- as.numeric(gsub(",",".",pdat[,paste(i)]))
}
df_long <- pivot_longer(pdat,cols =  c("PRE","Ex1","Ex2","Ex3","Ex4","Ex5","Ex6"))
df_long$name <- factor(df_long$name, levels =  c("PRE","Ex1","Ex2","Ex3","Ex4","Ex5","Ex6"))

p1 <- ggplot(df_long,aes(name, value, color = BFL_grouping)) + 
  geom_boxplot(outlier.shape = NA) + 
  geom_point(position = position_jitterdodge(jitter.width = 0.15))  + ylim(0, 110) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank()) +
  scale_color_manual(values = c("black","#5D3A9B", "#E66100")) + 
  #ggtitle("stratifying by using the BFL approach") + 
  ylab("freezing / %") + 
  xlab("Session")
p1

pdf("../Plots_NEWANALYSES/Figure5_boxplot_IFS_resilienceGroups_freezingDuringExtinction.pdf", height = 3.1, width = 6.4)
print(p1)
dev.off()

pdat_new <- gather(pdat, key = "time", value = "freezing", PRE, Ex1, Ex2, Ex3, Ex4, Ex5, Ex6)

df <- data.frame(pdat_new$animal_ID, pdat_new$BFL_grouping, pdat_new$time, pdat_new$freezing)
colnames(df) <- c("animal_ID", "BFL_grouping", "Time", "Freezing")

df %>%
  group_by(BFL_grouping, Time) %>%
  shapiro_test(Freezing)

res.aov <- anova_test(data = df, dv = Freezing, wid = animal_ID,between = BFL_grouping, within= Time)
get_anova_table(res.aov)

# Effect of group at each time point
one.way <- df %>%
  group_by(Time) %>%
  anova_test(dv = Freezing, wid = animal_ID, between = BFL_grouping) %>%
  get_anova_table() %>%
  adjust_pvalue(method = "bonferroni")
one.way

# Pairwise comparisons between group levels
pwc <- df %>%
  group_by(Time) %>%
  pairwise_t_test(Freezing ~ BFL_grouping, p.adjust.method = "bonferroni")
pwc
```
