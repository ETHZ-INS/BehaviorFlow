---
title: "Figure1_kmeans_70Clusters"
author: "Fabienne RÃ¶ssler"
date: '2023-02-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning = FALSE}
source("DLCAnalyzer.R")
source("BFA_BFF.R")
library(sp)         #tested with v1.3-2
library(imputeTS)   #tested with v2.7
library(ggplot2)    #tested with v3.1.0
library(ggmap)      #tested with v3.0.0
library(data.table) #tested with v1.12.8
library(cowplot)    #tested with v0.9.4
library(corrplot)   #tested with v0.84
library(keras)      #REQUIRES TENSORFLOW INSTALL. tested with v2.2.5.0
library(readr)
library(tidyr)
library(biganalytics)
library(M3C)
library(stringr)
library(reticulate)
set.seed(123)
```

# Figure 1 (for kmeans with 70 clusters)

```{r}
US <- readRDS("../data/US_CSI_SensitivityAssays_processed.rds")
US_temp <- readRDS("../data/US_AllData_raw.rds")

US_temp <- SplitUSData(US_temp,select = US_temp$meta$Session =="PostCSI")
US$Report$raw <- US_temp$Report$raw

US <- TwoGroupAnalysis(US, US$meta$Condition, lab = "kmeans.70_CSI")
```


## Boxplots for raw readouts

```{r, fig.height=3.1, fig.width=4}
stats <- US$Results$`CSI-vs-Control`$Statistics$raw
pdat <- US$Report$raw

# Repeat multiple testing correction for raw readouts
group <- US_temp$meta$Condition

pdat <- dplyr::select(pdat,!dplyr::contains("kmeans"))

res <- NULL
for(i in names(pdat)){
  a <- pdat[group == unique(group)[1],i]
  b <- pdat[group == unique(group)[2],i]
  nline <- data.frame(i, t.test(a,b)$statistic, t.test(a,b)$parameter, t.test(a,b)$p.value, mean(a), mean(b), mean(a) / mean(b))
  names(nline) <- c("name","t", "df", "p",unique(group)[1], unique(group)[2], "FC")
  res <- rbind(res,nline)
}
res$FDR <- p.adjust(res$p, method = "BY")
stats <- res

stats

pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
assign <- match(pdat$filename, US_temp$meta$filename)
pdat$Group <- US_temp$meta$Condition[assign]

pdat <- pdat[pdat$key %in% c("classifications.Supported.count","classifications.Unsupported.count","bodycentre.center.total.time","bodycentre.distance.moving"),]
p1 <- ggplot(pdat,aes(Group,value, color = Group)) + 
  geom_boxplot(outlier.shape = NA) + 
  scale_color_manual(values = c("black","#0072B2")) + 
  geom_point(position = position_jitter(width = 0.15)) + 
  facet_wrap(~key, scales = "free") + 
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank())
 
stats[stats$name %in% c("classifications.Supported.count","classifications.Unsupported.count","bodycentre.center.total.time","bodycentre.distance.moving"),]

print(p1)

pdf("../../Plots/Figure1_classicalReadouts_boxplot.pdf", height = 3.1, width = 4)
print(p1)
dev.off()
```

## Barplot for occurence of different clusters

```{r, fig.height=1.5, fig.width=11}
pdat <- US$Report$kmeans.70_CSI
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US$meta$filename)
pdat$Group <- US$meta$Condition[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 70, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(30)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#0072B2")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(1:70)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../../Plots/Figure1_kmeans70_barplot.pdf", height = 1.5, width = 11)
print(p1)
dev.off()

US$Results[[1]]$Statistics$kmeans.70_CSI

cluster_stats <- US$Results[[1]]$Statistics$kmeans.70_CSI
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```

## Circle plots for transitions between clusters

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow(US,lab = "kmeans.70_CSI")

pdf("../../Plots/Figure1_kmeans70_circlePlot.pdf", height = 5, width = 5)
PlotBehaviorFlow(US,lab = "kmeans.70_CSI")
dev.off()
```

```{r, fig.height=5, fig.width=5}
mat <- 0
for(i in US$file_names){
  mat <- mat + US$files[[i]]$transmatrix[["kmeans.70_CSI"]]
}
len <- nrow(mat)
#colors with good contrast. note, they will start to repeat after the 25 entries supplied
contrastcols <- c(
  "dodgerblue2", "#E31A1C", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "black", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown")
cols <- contrastcols[(1:len %% length(contrastcols) + 1)]
names(cols) <- rownames(mat)

mat_temp <- mat[rownames(mat) %in% c("41", "23", "69", "45"), colnames(mat) %in% c("41", "23", "69", "45")]
# list_clusters <- rbind(c("41", "23", "69", "45"), colnames(mat_temp[,colSums(mat_temp)>0]))
# mat_temp <- mat[rownames(mat) %in% unique(list_clusters), ]
# mat_temp <- mat
# mat_temp[mat_temp < 150] <- 0

#plot chord
circlize::chordDiagramFromMatrix(mat_temp,grid.col = cols)

pdf("../Plots_NEWANALYSES/Figure1_kmeans70_circlePlot_reduced.pdf", height = 5, width = 5)
circlize::chordDiagramFromMatrix(mat_temp,grid.col = cols)
dev.off()
```


## Results of bootstrapping analysis

```{r, fig.width= 5, fig.height=1.8}
PlotTransitionsStats(US, labels = "kmeans.70_CSI")

pdf("../Plots_NEWANALYSES/Figure1_BFA_kmeans70.pdf", height = 1.8, width = 5)
PlotTransitionsStats(US, labels = "kmeans.70_CSI")
dev.off()
```


## Results of power analysis

Plot for comparison between different classical readouts and different clustering assessment methods:

```{r, fig.width= 2.2, fig.height=1.8}
include <- "kmeans.70_CSI"
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US, US$meta$Condition, lab = k)
  A <- USt$meta$ratio[USt$meta$Condition == "CSI"]
  B <- USt$meta$ratio[USt$meta$Condition == "Control"]
  CD <- rbind(CD, data.frame(test = "CSI-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "CSI-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results_weighted <- CohensD_weighted(US)
Results_trans <- data.frame(test = "CSI-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US$Results[[1]]$TransitionStats$kmeans.70_CSI$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:50
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "kmeans.70_CSI_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#994F88")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p

pdf("../Plots_NEWANALYSES/Figure1_PowerPlots_CSI.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```

Plot for comparing different cluster numbers:

```{r,fig.width= 2.2, fig.height=1.8}
include <- c("kmeans.10_CSI","kmeans.25_CSI","kmeans.70_CSI","kmeans.100_CSI")
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US, US$meta$Condition, lab = k)
  A <- USt$meta$ratio[USt$meta$Condition == "CSI"]
  B <- USt$meta$ratio[USt$meta$Condition == "Control"]
  CD <- rbind(CD, data.frame(test = "CSI-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "CSI-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results_weighted <- CohensD_weighted(US)
#Results_trans <- data.frame(test = "CSI-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US1$Results[[1]]$TransitionStats$kmeans.25$transitions[1, ]$CohensD)
Results <- rbind(Results, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:50
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
#select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "kmeans.10_CSI_BFL","kmeans.25_CSI_BFL","kmeans.70_CSI_BFL","kmeans.100_CSI_BFL")
select <- c("kmeans.10_CSI_BFL","kmeans.25_CSI_BFL","kmeans.70_CSI_BFL","kmeans.100_CSI_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#D5B9D1","#B27CA6", "#8A487A","#511B44")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p

pdf("../Plots_NEWANALYSES/Figure1_PowerPlots_CSI_diffClusteringNumbers.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```


Plot for comparison between different clustering algorithms:

```{r, fig.width= 2.2, fig.height=1.8}
include <- c("BSOID.8", "kmeans.25_CSI", "VAME.80")
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US, US$meta$Condition, lab = k)
  A <- USt$meta$ratio[USt$meta$Condition == "CSI"]
  B <- USt$meta$ratio[USt$meta$Condition == "Control"]
  CD <- rbind(CD, data.frame(test = "CSI-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "CSI-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results_weighted <- CohensD_weighted(US)
#Results_trans <- data.frame(test = "CSI-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US1$Results[[1]]$TransitionStats$kmeans.25$transitions[1, ]$CohensD)
Results <- rbind(Results, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:50
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
#select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "BSOID.8_BFL","VAME.80_BFL","kmeans.25_CSI_BFL")
select <- c("BSOID.8_BFL","VAME.80_BFL","kmeans.25_CSI_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#90c789","#f09230", "#B27CA6")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  # theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  # panel.background = element_blank(), axis.line = element_line(colour = "black"))
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p

pdf("../Plots_NEWANALYSES/Figure1_PowerPlots_CSI_diffAlgorithms.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```


Plot for different integration periods:

```{r,fig.width= 3.43, fig.height=1.7}
p1 <- ggplot(means[means$Group.1 %in% c("kmeans.70.5.matstats.p","kmeans.70.10.matstats.p","kmeans.70.matstats.p", "kmeans.70.30.matstats.p","classical.top.p","DLC.PCA.p"),], 
             aes(GroupSize,p.value, color = Group.1)) + 
  geom_ribbon(aes(ymin = p.value-sem,ymax = p.value+sem, fill = Group.1,alpha = 0.1)) + 
  geom_line(size = 1) +
  scale_x_reverse() +
  ylim(0.3, 9.3) +
  scale_color_manual(values = c("grey","black", "#6F9FD3","#114375","#A5C9E9", "#35669B")) +
  scale_fill_manual(values = c("grey","black", "#6F9FD3","#114375","#A5C9E9", "#35669B")) +
  #geom_hline(yintercept = -log10(0.05), color = "red") +
  theme_bw() + ylab("-log10(p-value)") + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"))

print(p1)

pdf("../../Plots/Figure1_SensitivityCurves_diffIntegrationPeriod.pdf", height = 1.7, width = 3.47)
print(p1)
dev.off()
```