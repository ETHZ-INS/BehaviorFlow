---
title: "SupplFigure_VAME_AllData"
author: "Fabienne Roessler"
date: '2024-03-05'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning = FALSE}
source("DLCAnalyzer.R")
source("BFA_BFF.R")
library(sp)         #tested with v1.3-2
library(imputeTS)   #tested with v2.7
library(ggplot2)    #tested with v3.1.0
library(ggmap)      #tested with v3.0.0
library(data.table) #tested with v1.12.8
library(cowplot)    #tested with v0.9.4
library(corrplot)   #tested with v0.84
library(keras)      #REQUIRES TENSORFLOW INSTALL. tested with v2.2.5.0
library(readr)
library(tidyr)
library(biganalytics)
library(M3C)
library(stringr)
library(reticulate)
set.seed(123)
```

# Supplementary Figure 4

```{r}
US <- readRDS("../data_revision/US_AllData_VAME.rds")
```

```{r}
US1 <- SplitUSData(US, select = US$meta$Session %in% c("PostCSI"))
US1 <- TwoGroupAnalysis(US1,group = US1$meta$Condition, lab = "VAME.25")

US2 <- SplitUSData(US, select = US$meta$Session %in% c("FST45min"))
US2 <- TwoGroupAnalysis(US2,group = US2$meta$Treatment, lab = "VAME.25")

US2_24h <- SplitUSData(US, select = US$meta$Session %in% c("FST24h"))
US2_24h <- TwoGroupAnalysis(US2_24h,group = US2_24h$meta$Treatment, lab = "VAME.25")

US3 <- SplitUSData(US, select = US$meta$Session == "PostYoh" & US$meta$Condition == "Control")
US3 <- TwoGroupAnalysis(US3,group = US3$meta$Treatment, lab = "VAME.25")

US4 <- SplitUSData(US,select = US$meta$Experiment %in% c("CRS"))
US4 <- TwoGroupAnalysis(US4,group = US4$meta$Condition, lab = "VAME.25")

US5 <- SplitUSData(US,select = US$meta$Experiment %in% c("DREADD"))
US5 <- TwoGroupAnalysis(US5,group = US5$meta$Treatment, lab = "VAME.25")

US_all <- SplitUSData(US, select = US$meta$Session %in% c("CRS1","PostCSI","FST45min","PostYoh","DREADD"))
US_all <- SplitUSData(US_all, omit = names(US_all$files)[US_all$meta$Condition == "Tunnel"] )
```

## CSI 

Barplot showing cluster usage:

```{r, fig.height=2, fig.width=5.4}
pdat <- US1$Report$VAME.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US1$meta$filename)
pdat$Group <- US1$meta$Condition[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(30)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#0072B2")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(0:24)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/SupplFig5_barplot_CSI_VAME.pdf", height = 1.8, width = 5.4)
print(p1)
dev.off()

cluster_stats <- US1$Results[[1]]$Statistics$VAME.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```

Behavior flow:

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US1, grouping = US1$meta$Condition == "CSI", lab = "VAME.25")

trans_stats <- US1$Results[[1]]$TransitionStats$VAME.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated

pdf("../Plots_NEWANALYSES/SupplFig5_CSI_behaviorFlowDelta_VAME.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US1, grouping = US1$meta$Condition == "CSI", lab = "VAME.25")
dev.off()
```

Results of BFA:

```{r, fig.width=5, fig.height=2.5}
PlotTransitionsStats(US1, labels = "VAME.25")

pdf("../Plots_NEWANALYSES/SupplFig5_bootstrapping_CSI_VAME.pdf", height = 2.25, width = 5)
PlotTransitionsStats(US1, labels = "VAME.25")
dev.off()
```

Power analysis curves:

```{r, fig.width= 2, fig.height=1.7}
include <- US1$label_names
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US1, US1$meta$Condition, lab = k)
  A <- USt$meta$ratio[USt$meta$Condition == "CSI"]
  B <- USt$meta$ratio[USt$meta$Condition == "Control"]
  CD <- rbind(CD, data.frame(test = "CSI-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US1$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "CSI-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results <- CohensD_weighted(US1)
Results_trans <- data.frame(test = "CSI-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US1$Results[[1]]$TransitionStats$VAME.25$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:50
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "VAME.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#f09230")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p 

pdf("../Plots_NEWANALYSES/SupplFig5_PowerPlots_CSI_VAME.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```

## AS 45 min

Barplot for cluster usage:

```{r, fig.height=1.8, fig.width=5.4}
pdat <- US2$Report$VAME.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US2$meta$filename)
pdat$Group <- US2$meta$Treatment[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(15)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#D52800")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(0:24)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/SupplFig5_barplot_AS45min_VAME.pdf", height = 1.8, width = 5.55)
print(p1)
dev.off()

cluster_stats <- US2$Results[[1]]$Statistics$VAME.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```
Behavior flow plot:

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US2, grouping = US2$meta$Treatment == "Swim", lab = "VAME.25")

trans_stats <- US2$Results[[1]]$TransitionStats$VAME.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated

pdf("../Plots_NEWANALYSES/SupplFig5_AS45min_behaviorFlowDelta_VAME.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US2, grouping = US2$meta$Treatment == "Swim", lab = "VAME.25")
dev.off()
```

BFA plot:

```{r, fig.width=5, fig.height=1.3}
PlotTransitionsStats(US2, labels = "VAME.25")

pdf("../Plots_NEWANALYSES/SupplFig5_bootstrapping_AS45min_VAME.pdf", height = 1.35, width = 5)
PlotTransitionsStats(US2, labels = "VAME.25")
dev.off()
```

```{r, fig.width=2, fig.height=1.5}
include <- US2$label_names
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US2, US2$meta$Treatment, lab = k)
  A <- USt$meta$ratio[USt$meta$Treatment == "Swim"]
  B <- USt$meta$ratio[USt$meta$Treatment == "Control"]
  CD <- rbind(CD, data.frame(test = "Swim-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US2$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "Swim-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results <- CohensD_weighted(US1)
Results_trans <- data.frame(test = "Swim-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US2$Results[[1]]$TransitionStats$VAME.25$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:30
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "VAME.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#f09230")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p 

pdf("../Plots_NEWANALYSES/SupplFig5_PowerPlots_AS45min_VAME.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```


## AS 24 hours

Barplot for cluster usage:

```{r, fig.height=2, fig.width=5.4}
pdat <- US2_24h$Report$VAME.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US2_24h$meta$filename)
pdat$Group <- US2_24h$meta$Treatment[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(15)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","black")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(1:25)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

# pdf("../../Plots/Figure2_barplot_FST45min.pdf", height = 2, width = 5.4)
# print(p1)
# dev.off()

cluster_stats <- US2_24h$Results[[1]]$Statistics$VAME.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```

Behavior flow plot:

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US2_24h, grouping = US2$meta$Treatment == "Swim", lab = "VAME.25")

trans_stats <- US2_24h$Results[[1]]$TransitionStats$VAME.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated

# pdf("../../Plots/Figure2_AS45min_behaviorFlowDelta.pdf", height = 5, width = 5)
# PlotBehaviorFlow_Delta(US2, grouping = US2$meta$Treatment == "Swim", lab = "kmeans.25")
# dev.off()
```

BFA plot:

```{r, fig.width=5, fig.height=1.5}
PlotTransitionsStats(US2_24h, labels = "VAME.25")

pdf("../Plots_NEWANALYSES/SupplFig5_bootstrapping_AS24h_VAME.pdf", height = 1.35, width = 5)
PlotTransitionsStats(US2_24h, labels = "VAME.25")
dev.off()
```

Power analysis curves:

```{r, fig.width=3, fig.height=1.5}
include <- US2_24h$label_names
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US2_24h, US2_24h$meta$Treatment, lab = k)
  A <- USt$meta$ratio[USt$meta$Treatment == "Swim"]
  B <- USt$meta$ratio[USt$meta$Treatment == "Control"]
  CD <- rbind(CD, data.frame(test = "Swim-vs-Control",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}
Results <- CohensD_weighted(US2_24h)
Results <- rbind(Results, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:50
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
select <- c("raw_Usage", "VAME.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("grey","#994F88")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"))
p

# pdf("../Plots_NEWANALYSES/Figure2_PowerPlots_AS24h.pdf", height = 1.5, width = 3.5)
# print(p)
# dev.off()
```

## Yohimbine

Barplot for cluster usage:

```{r, fig.height=2, fig.width=5.4}
pdat <- US3$Report$VAME.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US3$meta$filename)
pdat$Group <- US3$meta$Treatment[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(15)

pdat_temp <- pdat[pdat$Group == "Saline", ]
df$SEM[df$Group=="Saline"] <- aggregate(pdat_temp$value,by = list(pdat_temp$Cluster, pdat_temp$type, pdat_temp$Group), FUN = sd)$x / sqrt(5)

p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#CC79A7")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(0:24)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/SupplFig5_barplot_Yohimbine_VAME.pdf", height = 1.8, width = 5.65)
print(p1)
dev.off()

cluster_stats <- US3$Results[[1]]$Statistics$VAME.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```

Circle plot for transitions:

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US3, grouping = US3$meta$Treatment == "Yohimbin", lab = "VAME.25")

trans_stats <- US3$Results[[1]]$TransitionStats$VAME.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated

pdf("../Plots_NEWANALYSES/SupplFig5_Yohimbine_behaviorFlowDelta_VAME.pdf", height = 5, width = 5)
PlotBehaviorFlow_Delta(US3, grouping = US3$meta$Treatment == "Yohimbin", lab = "VAME.25")
dev.off()
```

BFA results:

```{r, fig.width= 5, fig.height=2.5}
PlotTransitionsStats(US3, labels = "VAME.25")

pdf("../Plots_NEWANALYSES/SupplFig5_bootstrapping_yohimbine_VAME.pdf", height = 2.25, width = 5)
PlotTransitionsStats(US3, labels = "VAME.25")
dev.off()
```

Power analysis curves:

```{r, fig.width=2, fig.height=2}
include <- US3$label_names
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US3, US3$meta$Treatment, lab = k)
  A <- USt$meta$ratio[USt$meta$Treatment == "Yohimbin"]
  B <- USt$meta$ratio[USt$meta$Treatment == "Saline"]
  CD <- rbind(CD, data.frame(test = "Saline-vs-Yohimbin",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US3$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "Yohimbin-vs-Saline",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results <- CohensD_weighted(US1)
Results_trans <- data.frame(test = "Yohimbin-vs-Saline",label = "best_trans", category = "Transitions", weighted_cohenD = US3$Results[[1]]$TransitionStats$VAME.25$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:12
sig <- 0.05

#select <- c("raw_Usage", "kmeans.10_BFL", "kmeans.25_BFL", "kmeans.50_BFL", "kmeans.100_BFL")
select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "VAME.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#f09230")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p 

pdf("../Plots_NEWANALYSES/SupplFig5_PowerPlots_Yohimbin_VAME.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```

## CRS

```{r, fig.height=2, fig.width=5.4}
pdat <- US4$Report$VAME.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US4$meta$filename)
pdat$Group <- US4$meta$Condition[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(16)


p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#009E73")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(0:24)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/SupplFig5_barplot_CRS_VAME.pdf", height = 1.8, width = 5.65)
print(p1)
dev.off()

cluster_stats <- US4$Results[[1]]$Statistics$VAME.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```

```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US4, grouping = US4$meta$Condition == "Repeated", lab = "VAME.25")

trans_stats <- US4$Results[[1]]$TransitionStats$VAME.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated

pdf("../Plots_NEWANALYSES/SupplFig5_behaviorFlow_CRS_VAME.pdf", height =5, width = 5)
PlotBehaviorFlow_Delta(US4, grouping = US4$meta$Condition == "Repeated", lab = "VAME.25")
dev.off()
```

```{r, fig.width=4, fig.height=2.5}
PlotTransitionsStats(US4, labels = "VAME.25")

pdf("../Plots_NEWANALYSES/SupplFig5_bootstrapping_CRS_VAME.pdf", height = 2.25, width = 5)
PlotTransitionsStats(US4, labels = "VAME.25")
dev.off()
```

```{r, fig.width= 2, fig.height=2}
include <- US4$label_names
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US4, US4$meta$Condition, lab = k)
  A <- USt$meta$ratio[USt$meta$Condition == "Repeated"]
  B <- USt$meta$ratio[USt$meta$Condition == "Control"]
  CD <- rbind(CD, data.frame(test = "Control-vs-Repeated",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US4$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "Repeated-vs-Control",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results <- CohensD_weighted(US1)
Results_trans <- data.frame(test = "Repeated-vs-Control",label = "best_trans", category = "Transitions", weighted_cohenD = US4$Results[[1]]$TransitionStats$VAME.25$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:30
sig <- 0.05

select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "VAME.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#f09230")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p 

pdf("../Plots_NEWANALYSES/SupplFig5_PowerPlots_CRS_VAME.pdf", height = 1.8, width = 2.2)
print(p)
dev.off()
```

## DREADD

```{r, fig.height=2, fig.width=5.25}
pdat <- US5$Report$VAME.25
pdat <- data.frame(filename = rownames(pdat),pdat)
pdat <- gather(pdat,key = "key",value = "value", -filename)
pdat$value[is.na(pdat$value)] <- 0
pdat$type <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][2]}))
pdat$Cluster <- unlist(lapply(pdat$key,FUN = function(x){strsplit(x, split = "\\.")[[1]][1]}))
pdat$Cluster <- as.integer(unlist(lapply(pdat$Cluster,FUN = function(x){strsplit(x, split = "X")[[1]][2]})))
assign <- match(pdat$filename, US5$meta$filename)
pdat$Group <- US5$meta$Treatment[assign]
pdat$value <- ifelse(pdat$type == "nframes",pdat$value / 25, pdat$value)
pdat$type[pdat$type == "nframes"] <- "time"
pdat <- pdat[pdat$type == "count",]
df <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = mean)
colnames(df) <- c("Cluster","type","Group","Mean")
df$SEM <- aggregate(pdat$value,by = list(pdat$Cluster, pdat$type, pdat$Group), FUN = sd)$x / sqrt(8)

df$Group <- factor(df$Group, levels = c("saline", "cloz"))

p1 <- ggplot(df, aes(x=Cluster, y=Mean, fill=Group, width = 0.75)) + 
  geom_bar(stat="identity", color="black", 
           position=position_dodge()) +
  scale_fill_manual(values = c("white","#E69F00")) +
  geom_errorbar(aes(ymin=Mean-SEM, ymax=Mean+SEM), width=.2,
                position=position_dodge(.8)) +
  #geom_point(data = pdat, aes(Cluster, value, color = Group), position = position_jitterdodge(.3), color = "black", alpha = 0.2, size = 0.3)+ 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + 
  scale_x_continuous(breaks = c(0:24)) +
  facet_wrap(~type, ncol = 1,scales = "free")

print(p1)

pdf("../Plots_NEWANALYSES/SupplFig5_barplot_DREADD_VAME.pdf", height = 1.8, width = 5.4)
print(p1)
dev.off()

cluster_stats <- US5$Results[[1]]$Statistics$VAME.25
cluster_stats_updated <- cluster_stats[grep("count", cluster_stats$name), ]
cluster_stats_updated$FDR <- p.adjust(cluster_stats_updated$p, method = "BY")
cluster_stats_updated
```


```{r, fig.height=5, fig.width=5}
PlotBehaviorFlow_Delta(US5, grouping = US5$meta$Treatment == "cloz", lab = "VAME.25")

trans_stats <- US5$Results[[1]]$TransitionStats$VAME.25$transitions
trans_stats_updated <- tidyr::drop_na(trans_stats, "p.value")
trans_stats_updated$FDR <- p.adjust(trans_stats_updated$p.value, method = "BY")
trans_stats_updated

pdf("../Plots_NEWANALYSES/SupplFig5_behaviorFlow_DREADD_VAME.pdf", height =5, width = 5)
PlotBehaviorFlow_Delta(US5, grouping = US5$meta$Treatment == "cloz", lab = "VAME.25")
dev.off()
```

```{r, fig.width=4, fig.height=2.5}
PlotTransitionsStats(US5, labels = "VAME.25")

pdf("../Plots_NEWANALYSES/SupplFig5_bootstrapping_DREADD_VAME.pdf", height = 2.25, width = 5)
PlotTransitionsStats(US5, labels = "VAME.25")
dev.off()
```

```{r, fig.width= 2, fig.height=2}
include <- US5$label_names
CD <- data.frame()
for(k in include){
  USt <- StratifyGroups(US5, US5$meta$Treatment, lab = k)
  A <- USt$meta$ratio[USt$meta$Treatment == "cloz"]
  B <- USt$meta$ratio[USt$meta$Treatment == "saline"]
  CD <- rbind(CD, data.frame(test = "saline-vs-cloz",label = k, category = "BFL", weighted_cohenD = abs(cohensD(A,B))))
}

include_raw <- c("bodycentre.center.total.time","bodycentre.distance.moving")
Results <- data.frame()
for(j in include_raw){
  curr_Results <- US5$Results[[1]]$Statistics$raw
  Results <- rbind(Results, data.frame(test = "saline-vs-cloz",label = j, category = "Usage", weighted_cohenD = curr_Results[which(curr_Results$name == j), ]$CohensD))
}

#Results <- CohensD_weighted(US1)
Results_trans <- data.frame(test = "saline-vs-cloz",label = "best_trans", category = "Transitions", weighted_cohenD = US5$Results[[1]]$TransitionStats$VAME.25$transitions[1, ]$CohensD)
Results <- rbind(Results, Results_trans, CD)
Results$group <- paste(Results$label,Results$category, sep ="_")

ns <- 3:30
sig <- 0.05

select <- c("bodycentre.center.total.time_Usage","bodycentre.distance.moving_Usage", "best_trans_Transitions", "VAME.25_BFL")
Pcurve <- Results[Results$group %in% select,]
pdat <- data.frame()
for(i in 1:nrow(Pcurve)){
  D <- Pcurve$weighted_cohenD[i]
  for(n in ns){
    power <- pwr.t.test(n, D, sig,power = NULL,type="two.sample", alternative="two.sided")$power
    pdat <- rbind(pdat,data.frame(test = Pcurve$group[i], n = n, power = power))
  }
}
pdat$test <- factor(pdat$test, levels = select)
p <- ggplot(pdat, aes(n,power, color = test)) + geom_line() + theme_bw() + scale_color_manual(values = c("#AFABAB","#3B3838","#880B08","#f09230")) + #+ scale_color_manual(values = c("grey","#D5B9D1","#B27CA6", "#8A487A","#511B44")) + 
  theme_bw() + xlab("group size") + ylim(0.1, 1) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black"), legend.position = "none")
p 

pdf("../Plots_NEWANALYSES/SupplFig5_PowerPlots_DREADD_VAME.pdf", height = 1.15, width = 2.2)
print(p)
dev.off()
```

## 2D embedding of all data

```{r, fig.width=5.5, fig.height=3.2}
US_all <- CalculateStabilizedTransitions(US_all,"Condition","Control",subset = US_all$meta$Session == "CRS1")
US_all <- CalculateStabilizedTransitions(US_all,"Condition","Control",subset = US_all$meta$Session == "PostCSI")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","Control",subset = US_all$meta$Session == "FST45min")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","Saline",subset = US_all$meta$Session == "PostYoh")
US_all <- CalculateStabilizedTransitions(US_all,"Treatment","saline",subset = US_all$meta$Session == "DREADD")

US_all$meta$Embedding <- "Control"
US_all$meta$Embedding[US_all$meta$Session == "CRS1" & US_all$meta$Condition != "Control"] <- "CRS"
US_all$meta$Embedding[US_all$meta$Session == "PostCSI" & US_all$meta$Condition != "Control"] <- "CSI"
US_all$meta$Embedding[US_all$meta$Session == "FST45min" & US_all$meta$Treatment != "Control"] <- "FST_45min"
US_all$meta$Embedding[US_all$meta$Session == "PostYoh" & US_all$meta$Treatment != "Saline"] <- "Yohimbin"
US_all$meta$Embedding[US_all$meta$Session == "DREADD" & US_all$meta$Treatment != "saline"] <- "DREADD"

p1 <- Plot2DEmbedding(US_all,transitionmatrices_stabilized = "VAME.25", colorby = "Embedding", colors = c("grey","#009E73","#0072B2","#E69F00", "#D52800", "#CC79A7"), seed = 123,
                      plot.sem = TRUE)
p1

pdf("../Plots_NEWANALYSES/SupplFig5_2Dembedding_allDatasets_VAME.pdf", height=3.2, width = 6.6)
print(p1)
dev.off()
```


## Confusion matrix between kmeans.25 and VAME.25

```{r, fig.width=5.5, fig.height=3.2}
ts_kmeans <- readRDS("../data/Trackingobject_transfer_Lukas_rerun.rds")

US_comb <- AddFromTrackingObject(US, ts_kmeans)

US_comb <- SmoothLabels_US(US_comb, 5)

US_comb <- CutUSdata(US_comb, maxlength = 14900)

US_comb <- CalculateMetrics(US_comb)
US_comb <- AddTransitionMatrixData(US_comb)

US_comb <- AddConfusionMatrix(US_comb, from = "kmeans.25", to = "VAME.25")
PlotConfusionMatrix(US_comb$ConfusionMatrix_norm$`kmeans.25-VAME.25`,pointsize = 4, hclust = TRUE)

pdf("../Plots_NEWANALYSES/SupplFig5_ConfusionMatrix_kmeans_to_VAME.pdf", height = 3.2, width = 6.6)
PlotConfusionMatrix(US_comb$ConfusionMatrix_norm$`kmeans.25-VAME.25`,pointsize = 4, hclust = TRUE)
dev.off()
```



## Example videos

```{r}
path_videos <- "D:\\Fabienne\\UnsupervisedAnalysis_Paper\\data\\Videos\\CRS_DREADD_mp4\\"
# Rename videos so they match the DLC file names
# list_videos <- list.files(path = path_videos, pattern = ".avi", all.files = TRUE)
# new_names_videos <- stringr::str_remove(list_videos, ".avi")
# new_names_videos <- paste(new_names_videos, "DLC_resnet50_RocheNetworkOmnitechLMAJan2shuffle1_1030000.avi", sep = "")
# 
# for (i in 1:length(list_videos)) {
#   old_name <- paste(path_videos, list_videos[i], sep = "")
#   new_name <- paste(path_videos, new_names_videos[i], sep = "")
#   file.rename(old_name, new_name)
# }

RenderClusterVideos(US_all, labels = "VAME.25", path.videos = path_videos, video.format = ".mp4", n = 2, output.folder = "Examples_TransferedClustering_VAME_25", fps = 25, offset.s = 300/25)
#RenderClusterVideos(US, labels = "kmeans.25", cluster.values= "5", path.videos = path_videos, n = 2, output.folder = "kmeans_25_C5_withLag05s", fps = 25, lag.s = 0.5, offset.s = 300/25)
```